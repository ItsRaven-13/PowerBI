name: Validar Power BI Reports

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validar:
    runs-on: windows-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Descargar pbi-tools
        run: |
          Invoke-WebRequest -Uri "https://github.com/pbi-tools/pbi-tools/releases/download/v1.3.0/pbi-tools-win-x64.zip" -OutFile "pbi-tools.zip"
          Expand-Archive -Path "pbi-tools.zip" -DestinationPath "pbi-tools"
          echo "##vso[task.prependpath]$(Resolve-Path ./pbi-tools)"
        shell: pwsh

      - name: Validar archivos .pbix en /reports
        run: |
          $reports = Get-ChildItem -Path "reports" -Recurse -Filter "*.pbix"
          if ($reports.Count -eq 0) {
              Write-Host "No se encontraron archivos .pbix en la carpeta 'reports'."
              exit 1
          }

          foreach ($report in $reports) {
              Write-Host "Validando archivo: $($report.FullName)"
              ./pbi-tools/pbi-tools.exe info -pbixPath $report.FullName
          }
        shell: pwsh
